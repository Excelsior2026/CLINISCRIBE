#!/bin/bash

# Post-installation script for CogniScribe
APP_PATH="/Applications/CogniScribe.app"
BUNDLED_DIR="/Library/Application Support/CogniScribe/BundledModels"
USER_HOME=$(eval echo ~$SUDO_USER)

echo "Running CogniScribe post-installation..."

# Set proper permissions
chmod -R 755 "$APP_PATH"
chown -R root:wheel "$APP_PATH"

# Remove quarantine attribute (only if not code-signed)
xattr -cr "$APP_PATH" 2>/dev/null || true

# Create application support directory
mkdir -p "$USER_HOME/Library/Application Support/com.bageltech.cogniscribe"
chown -R $SUDO_USER:staff "$USER_HOME/Library/Application Support/com.bageltech.cogniscribe"

# Install bundled models if available
if [ -d "$BUNDLED_DIR" ]; then
    echo "Installing bundled AI models..."

    # Install Whisper models - copy entire HuggingFace cache structure
    if [ -d "$BUNDLED_DIR/whisper/hub" ]; then
        echo "  Installing Whisper models to HuggingFace cache..."
        WHISPER_CACHE="$USER_HOME/.cache/huggingface"
        mkdir -p "$WHISPER_CACHE"
        cp -R "$BUNDLED_DIR/whisper/hub" "$WHISPER_CACHE/" 2>/dev/null || true
        chown -R $SUDO_USER:staff "$WHISPER_CACHE" 2>/dev/null || true
        echo "  ✓ Whisper models installed"
    fi

    # Install Ollama models if Ollama directory exists
    if [ -d "$BUNDLED_DIR/ollama" ]; then
        echo "  Installing Ollama models..."
        OLLAMA_MODELS_DIR="$USER_HOME/.ollama/models"
        mkdir -p "$OLLAMA_MODELS_DIR"
        cp -R "$BUNDLED_DIR/ollama/"* "$OLLAMA_MODELS_DIR/" 2>/dev/null || true
        chown -R $SUDO_USER:staff "$OLLAMA_MODELS_DIR"
        echo "  ✓ Ollama models installed"
    fi

    # Create marker file to indicate bundled models were installed
    echo '{"bundled_models_installed": true, "install_date": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > \
         "$USER_HOME/Library/Application Support/com.bageltech.cogniscribe/.models-installed"
    chown $SUDO_USER:staff "$USER_HOME/Library/Application Support/com.bageltech.cogniscribe/.models-installed"

    echo "✓ Bundled models installed successfully"
    echo "  Models are ready for offline use!"
else
    echo "No bundled models found - models will download on first run"
fi

echo "CogniScribe installation complete!"
echo "You can find CogniScribe in your Applications folder."

# Optional: Open app automatically
# open -a "$APP_PATH"

exit 0
